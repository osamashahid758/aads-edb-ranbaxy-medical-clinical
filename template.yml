AWSTemplateFormatVersion: '2010-09-09'
Description: 'ranbaxy medical data Glue ETL Pipeline - Generated by EDB Project Onboarding'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, qa, prod]
    Description: Deployment environment

  BusinessUsecase:
    Type: String
    Default: ranbaxy-medical-data
    Description: Business use case identifier

  BucketPrefix:
    Type: String
    Default: lly-edb
    Description: S3 bucket prefix for data storage

  Region:
    Type: String
    Default: us-east-2
    Description: AWS region for deployment

  VpcId:
    Type: String
    Default: vpc-xxxxxxxxx
    Description: VPC ID for Glue job

  SubnetIds:
    Type: CommaDelimitedList
    Default: subnet-xxxxxxxx,subnet-yyyyyyyy
    Description: Subnet IDs for Glue job

  SecurityGroupIds:
    Type: CommaDelimitedList
    Default: sg-xxxxxxxxx
    Description: Security group IDs for Glue job

Resources:
  # S3 Buckets for data storage
  RawDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${BucketPrefix}-${BusinessUsecase}-raw-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: 'DeployEnvironment'
          Value: 'dev'
        - Key: 'AppName'
          Value: 'ranbaxy medical data'
        - Key: 'CostCenter'
          Value: '100ARAS'
        - Key: 'CostCenterApprover'
          Value: ''
        - Key: 'SystemOwner'
          Value: 'osama@lilly.com'
        - Key: 'SystemCustodian'
          Value: ''
        - Key: 'PrimaryItContact'
          Value: ''
        - Key: 'Level1BusinessArea'
          Value: 'AADS'
        - Key: 'ProjectCenter'
          Value: '000000'
        - Key: 'DataClassification'
          Value: 'Yellow'
        - Key: 'Hipaa'
          Value: 'No'
        - Key: 'SourceGitRepo'
          Value: ''
        - Key: 'ApproverGroup'
          Value: ''
        - Key: 'ApplicationCi'
          Value: ''

  RefinedDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${BucketPrefix}-${BusinessUsecase}-refined-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: 'DeployEnvironment'
          Value: 'dev'
        - Key: 'AppName'
          Value: 'ranbaxy medical data'
        - Key: 'CostCenter'
          Value: '100ARAS'
        - Key: 'CostCenterApprover'
          Value: ''
        - Key: 'SystemOwner'
          Value: 'osama@lilly.com'
        - Key: 'SystemCustodian'
          Value: ''
        - Key: 'PrimaryItContact'
          Value: ''
        - Key: 'Level1BusinessArea'
          Value: 'AADS'
        - Key: 'ProjectCenter'
          Value: '000000'
        - Key: 'DataClassification'
          Value: 'Yellow'
        - Key: 'Hipaa'
          Value: 'No'
        - Key: 'SourceGitRepo'
          Value: ''
        - Key: 'ApproverGroup'
          Value: ''
        - Key: 'ApplicationCi'
          Value: ''

  CodeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${BucketPrefix}-${BusinessUsecase}-code-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: 'DeployEnvironment'
          Value: 'dev'
        - Key: 'AppName'
          Value: 'ranbaxy medical data'
        - Key: 'CostCenter'
          Value: '100ARAS'
        - Key: 'CostCenterApprover'
          Value: ''
        - Key: 'SystemOwner'
          Value: 'osama@lilly.com'
        - Key: 'SystemCustodian'
          Value: ''
        - Key: 'PrimaryItContact'
          Value: ''
        - Key: 'Level1BusinessArea'
          Value: 'AADS'
        - Key: 'ProjectCenter'
          Value: '000000'
        - Key: 'DataClassification'
          Value: 'Yellow'
        - Key: 'Hipaa'
          Value: 'No'
        - Key: 'SourceGitRepo'
          Value: ''
        - Key: 'ApproverGroup'
          Value: ''
        - Key: 'ApplicationCi'
          Value: ''

  # IAM Role for Glue with least-privilege access
  GlueServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'edb-${BusinessUsecase}-glue-service-role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      PermissionsBoundary: !Sub 'arn:aws:iam::${AWS::AccountId}:policy/LZ-IAM-Boundary'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: S3DataAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${RawDataBucket}/*'
                  - !GetAtt RawDataBucket.Arn
                  - !Sub '${RefinedDataBucket}/*'
                  - !GetAtt RefinedDataBucket.Arn
                  - !Sub '${CodeBucket}/*'
                  - !GetAtt CodeBucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - 'arn:aws:s3:::source-bucket'
                  - 'arn:aws:s3:::source-bucket/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - 'arn:aws:s3:::target-bucket'
                  - 'arn:aws:s3:::target-bucket/*'
        - PolicyName: CloudWatchLogging
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/*'
      Tags:
        - Key: 'DeployEnvironment'
          Value: 'dev'
        - Key: 'AppName'
          Value: 'ranbaxy medical data'
        - Key: 'CostCenter'
          Value: '100ARAS'
        - Key: 'CostCenterApprover'
          Value: ''
        - Key: 'SystemOwner'
          Value: 'osama@lilly.com'
        - Key: 'SystemCustodian'
          Value: ''
        - Key: 'PrimaryItContact'
          Value: ''
        - Key: 'Level1BusinessArea'
          Value: 'AADS'
        - Key: 'ProjectCenter'
          Value: '000000'
        - Key: 'DataClassification'
          Value: 'Yellow'
        - Key: 'Hipaa'
          Value: 'No'
        - Key: 'SourceGitRepo'
          Value: ''
        - Key: 'ApproverGroup'
          Value: ''
        - Key: 'ApplicationCi'
          Value: ''

  # Glue Job
  DataProcessingJob:
    Type: AWS::Glue::Job
    Properties:
      Name: !Sub 'edb-${BusinessUsecase}-transform-${Environment}'
      Role: !GetAtt GlueServiceRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${CodeBucket}/src/glue/ranbaxy-medical-data/job.py'
        PythonVersion: '3'
      DefaultArguments:
        '--config_s3_uri': !Sub 's3://${CodeBucket}/configs/ranbaxy-medical-data/blueprint.json'
        '--job-bookmark-option': 'job-bookmark-enable'
        '--enable-metrics': 'true'
        '--enable-continuous-cloudwatch-log': 'true'
        '--TempDir': !Sub 's3://${CodeBucket}/temp/'
        '--enable-spark-ui': 'true'
        '--spark-event-logs-path': !Sub 's3://${CodeBucket}/spark-logs/'
      GlueVersion: '4.0'
      WorkerType: G.1X
      NumberOfWorkers: 2
      Timeout: 60
      MaxRetries: 1
      Tags:
 
        DeployEnvironment: 'dev'
 
        AppName: 'ranbaxy medical data'
 
        CostCenter: '100ARAS'
 
        CostCenterApprover: ''
 
        SystemOwner: 'osama@lilly.com'
 
        SystemCustodian: ''
 
        PrimaryItContact: ''
 
        Level1BusinessArea: 'AADS'
 
        ProjectCenter: '000000'
 
        DataClassification: 'Yellow'
 
        Hipaa: 'No'
 
        SourceGitRepo: ''
 
        ApproverGroup: ''
 
        ApplicationCi: ''


Outputs:
  GlueJobName:
    Description: Name of the Glue ETL job
    Value: !Ref DataProcessingJob
    Export:
      Name: !Sub '${AWS::StackName}-GlueJobName'

  GlueJobArn:
    Description: ARN of the Glue ETL job
    Value: !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:job/${DataProcessingJob}'
    Export:
      Name: !Sub '${AWS::StackName}-GlueJobArn'

  RawDataBucketName:
    Description: Name of the raw data S3 bucket
    Value: !Ref RawDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-RawDataBucket'

  RefinedDataBucketName:
    Description: Name of the refined data S3 bucket
    Value: !Ref RefinedDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-RefinedDataBucket'

  CodeBucketName:
    Description: Name of the code S3 bucket
    Value: !Ref CodeBucket
    Export:
      Name: !Sub '${AWS::StackName}-CodeBucket'

